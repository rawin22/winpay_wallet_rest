@model Wallet.Pages.Shared.Components.BalanceCardsModel
@{
    // Note: 'favoriteCurrencies' is hardcoded here. Consider moving this to the Model or configuration
    // if it needs to be dynamic or user-specific in the future.
    var favoriteCurrencies = new List<string> { "usd", "thb", "eur" };
}

<div class="card p-0 radius-12">
    <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center gap-3" style="flex-wrap: nowrap;">
        @* --- Filter Toggles --- *@
        <div class="form-switch switch-success d-flex align-items-center gap-3">
            <input class="form-check-input" type="checkbox" role="switch" id="switchFavorites" asp-for="FavoritesOnly" />
            <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="switchFavorites">
                Favorites Only
            </label>
        </div>
        <div class="form-switch switch-success d-flex align-items-center gap-3">
            <input class="form-check-input" type="checkbox" role="switch" id="switchBalances" asp-for="HideZero" />
            <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="switchBalances">
                Hide 0 Balances
            </label>
        </div>
    </div>

    <div class="card-body p-24">
        @* === START CHANGE === *@
        @* Replace the responsive row with a flex container for horizontal scrolling *@
        <div class="d-flex flex-nowrap overflow-auto pb-3 gap-4 balance-cards-scroll-container">
            @* Added classes and gap *@
            @foreach (var balance in Model.Balances)
            {
                bool isFavorite = favoriteCurrencies.Contains(balance.CurrencyCode.ToLower());

                @* Keep the individual card structure largely the same, but ensure it's treated as a flex item *@
                @* We still use 'col' conceptually for the JS filter, but it won't wrap now. Add width constraints. *@
                <div class="col balance-card-item" style="min-width: 220px; max-width: 250px;" @* Add min/max width for consistency *@
                     data-currency="@balance.CurrencyCode.ToLower()"
                     data-balance="@balance.Balance.ToString(System.Globalization.CultureInfo.InvariantCulture)" @* Ensure invariant culture for JS parsing *@
                     data-is-favorite="@isFavorite.ToString().ToLower()">
                    @* Add favorite data attribute for easier JS filtering *@

                    <div class="balance-card h-100">
                        @* Removed outer 'col' div, applied data attributes here *@
                        <div class="card shadow-none border bg-gradient-end-3 h-100">
                            @* Ensure card takes full height of item *@
                            <div class="card-body p-20 d-flex flex-column">
                                @* Use flex-column for content alignment *@
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                                    <img src="~/images/customCurrency/@(balance.CurrencyCode.ToLower() + ".png")"
                                         class="w-40-px h-40-px rounded-circle flex-shrink-0 me-12 overflow-hidden"
                                         alt="@balance.CurrencyCode flag"
                                         onerror="this.onerror=null; this.src='/images/customCurrency/unk.png';" /> @* Added fallback image *@
                                    <div class="flex-grow-1">
                                        <a asp-page="/History/Statement"
                                           asp-route-accountId="@balance.AccountId"
                                           asp-route-accountNumber="@balance.AccountNumber"
                                           asp-route-currencyCode="@balance.CurrencyCode"
                                           asp-route-balance="@balance.Balance"
                                           asp-route-activeHoldsTotal="@balance.ActiveHoldsTotal"
                                           asp-route-balanceAvailable="@balance.BalanceAvailable"
                                           asp-route-baseCurrencyCode="@balance.BaseCurrencyCode"
                                           asp-route-balanceAvailableBase="@balance.BalanceAvailableBase"
                                           class="text-decoration-none">
                                            @* Removed underline class, link implies action *@
                                            <h6 class="text-xl mb-1 text-primary-light">@balance.CurrencyCode</h6>
                                        </a>
                                    </div>
                                </div>
                                <div class="mt-auto d-flex flex-wrap justify-content-between align-items-center gap-1 pt-3">
                                    @* mt-auto pushes this down, pt-3 adds space *@
                                    <div class="">
                                        <a asp-page="/History/Statement"
                                           asp-route-accountId="@balance.AccountId"
                                           asp-route-accountNumber="@balance.AccountNumber"
                                           asp-route-currencyCode="@balance.CurrencyCode"
                                           asp-route-balance="@balance.Balance"
                                           asp-route-activeHoldsTotal="@balance.ActiveHoldsTotal"
                                           asp-route-balanceAvailable="@balance.BalanceAvailable"
                                           asp-route-baseCurrencyCode="@balance.BaseCurrencyCode"
                                           asp-route-balanceAvailableBase="@balance.BalanceAvailableBase"
                                           class="text-decoration-none">
                                            @* Removed underline class *@
                                            <h6 class="mb-0 text-primary-light">@balance.Balance.ToString("N2")</h6> @* Use N2 for number format *@
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> @* End .balance-card-item *@
            }
        </div>
        @* === END CHANGE === *@
    </div>
</div>

@* --- Updated JavaScript --- *@
<script>
    // Ensure elements exist before adding listeners
    const switchFavorites = document.getElementById('switchFavorites');
    const switchBalances = document.getElementById('switchBalances');
    // Store favorite currencies from the C# variable (consider passing this differently if dynamic)
    const favoriteCurrencies = @Json.Serialize(favoriteCurrencies);

    if (switchFavorites) {
        switchFavorites.addEventListener('change', filterBalances);
    }
    if (switchBalances) {
        switchBalances.addEventListener('change', filterBalances);
    }

    function filterBalances() {
        const favOnly = switchFavorites ? switchFavorites.checked : false;
        const hideZero = switchBalances ? switchBalances.checked : false;
        let visibleCount = 0; // Keep track of visible cards

        document.querySelectorAll('.balance-card-item').forEach(function(cardItem) {
            // Read data attributes
            const balance = parseFloat(cardItem.getAttribute('data-balance'));
            const isFav = cardItem.getAttribute('data-is-favorite') === 'true'; // Check boolean attribute

            let show = true; // Assume visible initially

            // Apply filters
            if (favOnly && !isFav) {
                show = false;
            }
            // Check balance AFTER checking favOnly, otherwise non-favs are hidden based on balance too
            if (show && hideZero && balance <= 0) {
                show = false;
            }

            // Show/hide the entire card item container
            cardItem.style.display = show ? "" : "none";

            if (show) {
                visibleCount++;
            }
        });

        // Optional: Add/remove a class to the container if no items are visible
        const container = document.querySelector('.balance-cards-scroll-container');
        if (container) {
            if (visibleCount === 0) {
                container.classList.add('no-visible-balances');
                // You could add a message here if desired using ::after pseudo-element CSS or by adding an element via JS
            } else {
                container.classList.remove('no-visible-balances');
            }
        }
    }

    // Run filter on initial load to apply default checkbox states
    document.addEventListener('DOMContentLoaded', filterBalances);

</script>

@* Optional CSS to potentially add a message when filters hide everything *@
<style>
    .balance-cards-scroll-container.no-visible-balances::after {
        content: "No balances match the current filters.";
        display: block;
        text-align: center;
        padding: 20px;
        color: var(--bs-secondary-color); /* Bootstrap secondary text color */
        width: 100%; /* Ensure it takes container width */
    }
</style>